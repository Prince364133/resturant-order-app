<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="firebase-config.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            color: white;
            max-width: 100%;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        #bg-video {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -10;
            filter: blur(var(--blur-amt, 10px));
            transform: scale(1.1);
        }

        .invoice-sheet {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(50px);
            width: 100%;
            max-width: 600px;
            border-radius: 20px;
            padding: 40px;
            color: #333;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            margin-bottom: 80px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .logo-area img {
            max-height: 80px;
            margin-bottom: 10px;
        }

        .invoice-title {
            font-size: 2rem;
            color: #ccc;
            font-weight: 800;
        }

        .meta-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .bill-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        .bill-table th {
            text-align: left;
            border-bottom: 2px solid #eee;
            padding: 10px;
            color: #999;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .bill-table td {
            border-bottom: 1px solid #eee;
            padding: 15px 10px;
            font-weight: 500;
        }

        .action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        @media print {

            #bg-video,
            .action-bar {
                display: none;
            }

            body {
                padding: 0;
                background: white;
            }

            .invoice-sheet {
                box-shadow: none;
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <video id="bg-video" autoplay playsinline muted></video>
    <div class="invoice-sheet">
        <div class="header">
            <div class="logo-area">
                <img id="rest-logo" src="" alt="Logo" style="display:none">
                <div><strong id="rest-name">Loading...</strong><br>
                    <div id="rest-address" style="color:#666; font-size:0.9rem;"></div>
                    <div style="margin-top:5px; font-size:0.8rem;">GST: <span id="rest-gst">---</span></div>
                </div>
            </div>
            <div style="text-align:right">
                <div class="invoice-title">INVOICE</div>
                <div style="margin-top:5px; font-weight:600;">#<span id="bill-id">0000</span></div>
            </div>
        </div>
        <div class="meta-row">
            <div>
                <h4 style="margin:0 0 5px 0; color:#999; font-size:0.8rem;">BILLED TO</h4>
                <div id="cust-name" style="font-weight:700">Guest</div>
                <div id="cust-phone"></div>
                <div id="cust-table">Table --</div>
            </div>
            <div style="text-align: right;">
                <h4 style="margin:0 0 5px 0; color:#999; font-size:0.8rem;">DATE</h4>
                <div id="bill-date">--/--/----</div>
            </div>
        </div>
        <table class="bill-table">
            <thead>
                <tr>
                    <th>Description</th>
                    <th style="text-align: right;">Price</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong id="item-name">Item</strong>
                        <div style="font-size:0.8rem;color:#777">Qty: 1</div>
                    </td>
                    <td style="text-align: right;" id="item-price">0.00</td>
                </tr>
                <tr id="row-coupon" style="display:none; color: #30D158;">
                    <td>Discount <span id="cpn-code"
                            style="font-family:monospace; background:#eee; padding:2px 6px; border-radius:4px; font-size:0.8rem; color:#333;"></span>
                    </td>
                    <td style="text-align: right;">-<span id="cpn-amt"></span></td>
                </tr>
                <tr style="font-size: 1.2rem;">
                    <td style="padding-top:20px; font-weight:800;">TOTAL</td>
                    <td style="text-align: right; padding-top:20px; font-weight:800;" id="bill-total">0.00</td>
                </tr>
            </tbody>
        </table>
        <div style="text-align:center; color:#999; font-size:0.9rem; margin-top:40px;">Thank you for your visit!</div>
    </div>
    <div class="action-bar"><button class="btn btn-primary" onclick="downloadPDF()">Download PDF</button><button
            class="btn btn-glass" onclick="location.href='home.html'">Home</button></div>
    <script>
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const orderId = new URLSearchParams(window.location.search).get('orderId');
        const blurPref = localStorage.getItem('blurPref') || '10';
        document.documentElement.style.setProperty('--blur-amt', blurPref + 'px');
        let CUR = '$';

        window.onload = async () => {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }).then(s => { document.getElementById('bg-video').srcObject = s; });
            if (!orderId) document.querySelector('.invoice-sheet').innerHTML = '<h3 style="text-align:center">No Order ID</h3>';
            else {
                const sSnap = await db.collection('settings').doc('restaurant').get();
                const settings = sSnap.data() || {};
                if (settings.currency) CUR = settings.currency;
                const oSnap = await db.collection('orders').doc(orderId).get();
                renderBill(oSnap.data(), settings);
            }
        };

        function renderBill(o, s) {
            document.getElementById('rest-name').innerText = s.bizName || "SnapFood";
            document.getElementById('rest-address').innerText = s.bizAddress || "";
            document.getElementById('rest-gst').innerText = s.taxId || "---";
            if (s.appLogo) { document.getElementById('rest-logo').src = s.appLogo; document.getElementById('rest-logo').style.display = 'block'; }

            document.getElementById('bill-id').innerText = orderId.slice(0, 6).toUpperCase();
            document.getElementById('cust-name').innerText = o.customerName || "Guest";
            document.getElementById('cust-phone').innerText = o.phone || "";
            document.getElementById('cust-table').innerText = "Table: " + o.tableNo;
            document.getElementById('bill-date').innerText = new Date().toLocaleDateString();

            document.getElementById('item-name').innerText = o.dishName;
            let price = parseFloat(o.price);
            document.getElementById('item-price').innerText = CUR + price.toFixed(2);

            if (o.discount) {
                document.getElementById('row-coupon').style.display = 'table-row';
                document.getElementById('cpn-code').innerText = o.couponCode;
                document.getElementById('cpn-amt').innerText = CUR + o.discount.toFixed(2);
                price = o.finalTotal;
            }
            document.getElementById('bill-total').innerText = CUR + price.toFixed(2);
        }

        function downloadPDF() {
            const el = document.querySelector('.invoice-sheet');
            // Hide action bar for PDF if needed, but html2pdf selects element so it's fine.
            // We need to ensure the background is white for the PDF
            const opt = {
                margin: 10,
                filename: `Invoice_${orderId}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(el).save();
        }
    </script>
</body>

</html>